// PIO Test with Blocking Writes - No DMA
#include <hardware/pio.h>
#include <hardware/gpio.h>
#include "simple_tx.pio.h"

constexpr size_t TX_DATA_PIN = 0;
constexpr size_t RX_DATA_PIN = 3;

PIO tx_pio = pio0;
uint tx_sm;

// Core 0: Transmit using PIO
void setup() {
  Serial.begin(115200);
  delay(3000);

  Serial.println("\n=== PIO BLOCKING WRITE TEST ===");
  Serial.println("Testing PIO output with manual blocking writes");
  Serial.println("Wiring: GPIO 0 -> GPIO 3\n");

  // Setup PIO
  uint offset = pio_add_program(tx_pio, &simple_tx_program);
  tx_sm = pio_claim_unused_sm(tx_pio, true);

  // Slow clock for debugging: 1000 Hz per instruction
  // pull=1 cycle, 8x(out+jmp)=16 cycles = 17 cycles per byte
  // At 1000 Hz, one byte takes 17ms
  float clk_div = clock_get_hz(clk_sys) / 1000.0f;

  simple_tx_program_init(tx_pio, tx_sm, offset, TX_DATA_PIN, clk_div);

  Serial.print("PIO initialized, SM: ");
  Serial.println(tx_sm);
  Serial.print("Clock divider: ");
  Serial.println(clk_div);
  Serial.println();
}

uint8_t patterns[] = {0x00, 0xFF, 0xAA, 0x55, 0xF0, 0x0F, 0x01, 0x80};
const char* pattern_names[] = {
  "0x00 (00000000)",
  "0xFF (11111111)",
  "0xAA (10101010)",
  "0x55 (01010101)",
  "0xF0 (11110000)",
  "0x0F (00001111)",
  "0x01 (00000001)",
  "0x80 (10000000)"
};
uint8_t pattern_index = 0;

void loop() {
  uint8_t pattern = patterns[pattern_index];

  Serial.print("TX: Sending ");
  Serial.print(pattern_names[pattern_index]);
  Serial.print(" ... ");

  // Send via PIO using blocking write
  pio_sm_put_blocking(tx_pio, tx_sm, pattern);

  Serial.println("sent!");

  pattern_index = (pattern_index + 1) % 8;
  delay(2000); // 2 seconds between patterns
}

// Core 1: Receive using GPIO
void setup1() {
  delay(4000);

  Serial.println("=== CORE 1: RX MONITORING ===");
  Serial.println("Reading GPIO 3 directly\n");

  gpio_init(RX_DATA_PIN);
  gpio_set_dir(RX_DATA_PIN, GPIO_IN);
}

uint8_t last_value = 2;
uint32_t sample_count = 0;

void loop1() {
  uint8_t value = gpio_get(RX_DATA_PIN);

  // Report on changes
  if (value != last_value) {
    Serial.print("RX [");
    Serial.print(sample_count);
    Serial.print("]: GPIO 3 = ");
    Serial.println(value);
    last_value = value;
  }

  sample_count++;
  delay(10); // Sample every 10ms
}
